name: PR Review Apps

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  backend-review-app:
    name: Backend Review App
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Backend Review App
        id: deploy
        uses: superfly/fly-pr-review-apps@1.2.1
        with:
          name: stepwise-backend-pr-${{ github.event.number }}
          config: backend/fly.toml
          region: sjc
          org: personal
          secrets: |
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            DATABASE_URL=sqlite:////data/stepwise.db
            EMAIL_PROVIDER=console
            API_ACCESS_KEY=dev-test-key

  frontend-review-app:
    name: Frontend Review App
    runs-on: ubuntu-latest
    needs: backend-review-app
    if: github.event.action != 'closed'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Frontend Review App
        uses: superfly/fly-pr-review-apps@1.2.1
        with:
          name: stepwise-frontend-pr-${{ github.event.number }}
          config: frontend/fly.toml
          region: sjc
          org: personal
          build_args: |
            VITE_API_BASE_URL=${{ needs.backend-review-app.outputs.url }}

  comment-urls:
    name: Comment PR URLs
    runs-on: ubuntu-latest
    needs: [backend-review-app, frontend-review-app]
    if: github.event.action != 'closed'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const backendUrl = `https://stepwise-backend-pr-${prNumber}.fly.dev`;
            const frontendUrl = `https://stepwise-frontend-pr-${prNumber}.fly.dev`;

            const body = `## ðŸš€ Review App Deployed

            | Service | URL |
            |---------|-----|
            | Frontend | ${frontendUrl} |
            | Backend | ${backendUrl} |
            | API Docs | ${backendUrl}/docs |

            > Apps will be automatically destroyed when this PR is closed.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Review App Deployed')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  cleanup:
    name: Cleanup Review Apps
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Destroy Backend Review App
        run: flyctl apps destroy stepwise-backend-pr-${{ github.event.number }} --yes
        continue-on-error: true

      - name: Destroy Frontend Review App
        run: flyctl apps destroy stepwise-frontend-pr-${{ github.event.number }} --yes
        continue-on-error: true
