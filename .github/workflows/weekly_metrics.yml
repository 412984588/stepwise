name: Weekly Email Metrics

on:
  # Run every Monday at 00:00 UTC
  schedule:
    - cron: '0 0 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to analyze'
        required: false
        default: '7'
        type: string

jobs:
  monitor-metrics:
    name: Monitor SendGrid Metrics
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Run metrics monitor
        id: metrics
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          # Determine days to analyze
          DAYS="${{ github.event.inputs.days || '7' }}"
          
          # Run monitor script with GitHub output format
          python scripts/monitor_unsubscribe_rate.py \
            --days "$DAYS" \
            --output github \
            > metrics_output.md
          
          # Capture exit code
          EXIT_CODE=$?
          
          # Output to step summary
          cat metrics_output.md >> $GITHUB_STEP_SUMMARY
          
          # Set output for notification
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Exit with captured code
          exit $EXIT_CODE
      
      - name: Create issue on critical status
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metricsOutput = fs.readFileSync('metrics_output.md', 'utf8');
            
            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ CRITICAL: Email Unsubscribe Rate Exceeded Threshold',
              body: `## Critical Alert
            
            The weekly email metrics monitoring has detected a critical unsubscribe rate.
            
            ${metricsOutput}
            
            ## Action Required
            
            1. Review recent email campaigns
            2. Check email frequency and content
            3. Verify email list quality
            4. Review SendGrid dashboard for detailed analytics
            
            ## Workflow Run
            
            - **Workflow**: ${context.workflow}
            - **Run ID**: ${context.runId}
            - **Run URL**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            ---
            
            *This issue was automatically created by the Weekly Email Metrics workflow.*
            `,
              labels: ['critical', 'email-metrics', 'automated']
            });
      
      - name: Send Slack notification (optional)
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "ðŸš¨ CRITICAL: Email unsubscribe rate exceeded threshold",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Critical Email Metrics Alert"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The weekly email metrics monitoring has detected a critical unsubscribe rate. Check GitHub Actions for details."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nCRITICAL"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
